<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>imgedit</title>
    <link rel="stylesheet" type="text/css" href="wasm.css">
    <script src="wasm_exec.js"></script>
    <script src="drop-zone.js"></script>
    <script src="wasm.js"></script>
</head>
<body>
<div class="wrapper">
    <header class="common-width">
        <h1>image edit tools</h1>
        <p>Image edit tools created from <a href="https://github.com/icemint0828/imgedit">imgedit package</a> with <a href="https://github.com/icemint0828/imgedit-wasm">wasm</a>.</p>
    </header>

    <div class="tab common-width">
        <ul class="tab-menu">
            <li class="active"><a href="#resize" data-toggle="tab">resize</a></li>
            <li><a href="#trim" data-toggle="tab">trim</a></li>
            <li><a href="#reverse" data-toggle="tab">reverse</a></li>
            <li><a href="#grayscale" data-toggle="tab">grayscale</a></li>
        </ul>
        <div class="tab-contents">
            <div class="tab-content" id="resize">
                <label>width:<input type="number" max="5000" min="0" step="1" id="resize-width">px</label>
                <label>height:<input type="number" max="5000" min="0" step="1" id="resize-height">px</label>
                <label>ratio:<input type="number" max="10" min="0.01" step="0.01" id="resize-ratio"></label>
                <button class="button" onClick="resize();">execute</button>
            </div>
            <div class="tab-content" id="trim">
                <label>left:<input type="number" max="5000" min="0" step="1" id="left">px</label>
                <label>top:<input type="number" max="5000" min="0" step="1" id="top">px</label>
                <label>width:<input type="number" max="5000" min="0" step="1" id="trim-width">px</label>
                <label>height:<input type="number" max="5000" min="0" step="1" id="trim-height">px</label>
                <button class="button" onClick="trim();">execute</button>
            </div>
            <div class="tab-content" id="reverse">
                <input type="checkbox" id="vertical" value="1"><label class="checkbox" for="vertical">vertical:</label>
                <button class="button" onClick="reverse();">execute</button>
            </div>
            <div class="tab-content" id="grayscale">
                <button class="button" onClick="grayscale();">execute</button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div class="status-bar">
            <span id="error-message" class="error"></span>
            <span id="image-status"></span>
            <span id="size-info"></span>
        </div>
        <div class="reset"><button class="button" name="reset" id="file-reset" onClick="reset();"></button></div>
        <div id="preview"></div>
    </div>
    <div class="upload-area common-width">
        <p>Drag and drop a file or <input class="button" type="file" name="file" id="file-input" accept=".png, .jpg, .jpeg, .gif"></p>
    </div>
    <div class="drop common-width" id="drop-zone"></div>
</div>
<script>
    let preview = document.getElementById('preview')
    let errorMessage = document.getElementById("error-message")
    let imageStatus = document.getElementById("image-status")

    function reset() {
        let fileInput = document.getElementById('file-input')
        if (fileInput.files.length > 0) {
            previewBlob(fileInput.files[0])
            imageStatus.innerHTML = "upload image"
        }
        errorMessage.innerHTML = ""
    }

    function previewBlob(blob) {
        let fr = new FileReader()
        fr.readAsDataURL(new File([blob], "name", {lastModified: 0}))
        fr.onload = function () {
            let img = document.createElement('img')
            let info = document.getElementById('size-info')
            img.setAttribute('src', String(fr.result))
            img.setAttribute('class', 'image')
            img.setAttribute('id', 'preview-image')
            preview.innerHTML = ''
            preview.appendChild(img)
            preview.appendChild(img).onload = function () {
                let previewImg = document.getElementById('preview-image')
                info.innerHTML = "(" + previewImg.naturalWidth + "Ã—" + previewImg.naturalHeight + ")"
            }
        }
    }

    let tabId = location.hash === ''? getTabId(document.querySelector('.tab-menu li:first-child a').href): location.hash;
    tabChange(tabId);

    let tabs = document.querySelectorAll('.tab-menu li a');
    tabs.forEach(function (aElement) {
        aElement.addEventListener('click', function () {
            tabChange(getTabId(aElement.href));
            return false;
        })
    })

    function getTabId(activeHref) {
        return activeHref.substring(activeHref.indexOf('#'));
    }

    function tabChange(activeId) {
        document.querySelector('.tab-menu li.active').classList.remove('active');
        document.querySelector('.tab-menu li a[href=\'' + activeId +'\']').parentElement.classList.add('active');

        document.querySelector('.tab-contents .tab-content' + activeId).classList.add('show');
        document.querySelector('.tab-contents .tab-content' + activeId).classList.remove('hide');
        let hideElements = document.querySelectorAll('.tab-contents .tab-content:not(' + activeId + ')');
        hideElements.forEach(function (hideElement) {
            hideElement.classList.add('hide');
            hideElement.classList.remove('show');
        })
    }
</script>
</body>
</html>
